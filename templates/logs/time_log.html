
{% extends 'base/dashboard.html' %}


{% block 'title' %}PSP | Time log{% endblock %}

{% block 'links' %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/time_log.css' %}">
    <link rel="stylesheet" href="{% static 'css/buttom_float.css' %}">
{% endblock %}


{% block 'content' %}

    {% if is_active_phase %}
        <div class="row">
            <div class="col-xl-9 mt-3">
                <div class="au-card text-center">
                    <div class="container__time__log">
                        <p><span id="time_hours">00</span> : <span id="time_mins">00</span> : <span id="time_seg">00</span></p>
                    </div>
                    <div class="row controllers__timer justify-content-center">

                        <!-- Button chronometer is running -->
                        <button id="btn-pause-chronometer" class="btn btn-info mr-2 pl-4 pr-4 {% if time_log.is_paused %}d-none{% endif %}"><i class="fas fa-pause"></i></button>

                        <!-- Button chronometer is paused -->
                        <button id="btn-reset-chronometer" class="btn btn-info mr-2 pl-4 pr-4 {% if not time_log.is_paused %}d-none{% endif %}"><i class="fas fa-play"></i></button>

                        <!-- Button stop phase and save time -->
                        <button id="btn-stop-chronometer" class="btn btn-danger pl-4 pr-4"><i class="fas fa-stop"></i></button>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 pl-3 mt-3">
                <div class="au-card">
                    <p>Code</p>
                </div>
            </div>
        </div>
        <br/>
        <br/>
    {% endif %}
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th scope="col">Phase</th>
                <th scope="col">Start Date and Time</th>
                <th scope="col">Stop Date and Time</th>
                <th scope="col">Total time</th>
                <th scope="col">Comments</th>
            </tr>
        </thead>
        <tbody>
            {% for time_log in program_opened.program_log_time.all %}
                <tr>
                    <td>{{ time_log.phase }}</td>
                    <td>
                        {% load tz %}
                        {% timezone "America/Bogota" %}
                            {{ time_log.start_date }}
                        {% endtimezone %}
                    </td>
                    <td>
                        {% if not time_log.finish_date %}
                            ---
                        {% else %}
                            {% timezone "America/Bogota" %}
                                {{ time_log.finish_date }}
                            {% endtimezone %}
                        {% endif %}
                    </td>
                    <td>{{ time_log.delta_time }}</td>
                    <td>{{ time_log.comments }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if not is_active_phase %}
        <!-- Button trigger modal -->
        <button type="button" class="btn-flotante" title="Nuevo tiempo" data-toggle="modal" data-target="#modalCreateTimeLog">
            <i class="fas fa-plus"></i>
        </button>
    {% endif %}
{% endblock %}


{% block 'scripts' %}
    {% load static %}
    <script src="{% static 'js/count_words.js' %}"></script>
    <script src="{% static 'js/ParseTime.js' %}"></script>
    <script src="{% static 'js/ServiceChronometer.js' %}"></script>
    <script src="{% static 'js/Chronometer.js' %}"></script>

    <script>
        const textTimeHours = document.getElementById('time_hours')
        const textTimeMins = document.getElementById('time_mins')
        const textTimeSeg = document.getElementById('time_seg')

        const btnPauseChronometer = document.getElementById('btn-pause-chronometer')
        const btnResetChronometer = document.getElementById('btn-reset-chronometer')
        const btnStopChronometer = document.getElementById('btn-stop-chronometer')

        var totalSeconds = parseInt("{{ total_time }}")

        {% if time_log %}
            var idTimeLog = "{{ time_log.pk }}"

            const chronometer = new Chronometer(textTimeHours, textTimeMins, textTimeSeg, totalSeconds, idTimeLog)
            chronometer.updateValues()


            btnPauseChronometer.addEventListener('click', () => {
                chronometer.pause()

                btnPauseChronometer.classList.add('d-none')
                btnResetChronometer.classList.remove('d-none')
            })

            btnResetChronometer.addEventListener('click', () => {
                chronometer.restart()

                btnPauseChronometer.classList.remove('d-none')
                btnResetChronometer.classList.add('d-none')
            })

            window.addEventListener('beforeunload', () => {
                chronometer.pause()
            })

            {% if not time_log.is_paused %}
                chronometer.start()
            {% endif %}

        {% endif %}

    </script>

{% endblock %}
